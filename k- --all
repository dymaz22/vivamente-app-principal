[33mcommit 449872369dbaf040f6957620773eb106918f0334[m[33m ([m[1;36mHEAD[m[33m -> [m[1;32mmain[m[33m, [m[1;31morigin/main[m[33m, [m[1;31morigin/HEAD[m[33m)[m
Author: menteviva3-coder <menteviva3@gmail.com>
Date:   Wed Dec 17 16:53:19 2025 -0300

    fix: migraÃ§Ã£o IA Gemini â†’ OpenAI (em progresso)

[1mdiff --git a/functions/openai.cjs b/functions/openai.cjs[m
[1mnew file mode 100644[m
[1mindex 00000000..033c0d61[m
[1m--- /dev/null[m
[1m+++ b/functions/openai.cjs[m
[36m@@ -0,0 +1,155 @@[m
[32m+[m[32m// functions/openai.cjs[m
[32m+[m[32m// Endpoint: /.netlify/functions/openai[m
[32m+[m[32m// Provider: OpenAI | Model: gpt-4o-mini[m
[32m+[m
[32m+[m[32mconst { createClient } = require('@supabase/supabase-js');[m
[32m+[m
[32m+[m[32mfunction safeString(v) {[m
[32m+[m[32m  return typeof v === 'string' ? v : String(v ?? '');[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mexports.handler = async function (event) {[m
[32m+[m[32m  const headers = {[m
[32m+[m[32m    'Access-Control-Allow-Origin': '*',[m
[32m+[m[32m    'Access-Control-Allow-Headers': 'Content-Type',[m
[32m+[m[32m    'Content-Type': 'application/json',[m
[32m+[m[32m  };[m
[32m+[m
[32m+[m[32m  if (event.httpMethod === 'OPTIONS') {[m
[32m+[m[32m    return { statusCode: 200, headers, body: 'ok' };[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  try {[m
[32m+[m[32m    const apiKey = process.env.OPENAI_API_KEY;[m
[32m+[m[32m    const supabaseUrl = process.env.SUPABASE_URL;[m
[32m+[m[32m    const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;[m
[32m+[m
[32m+[m[32m    if (!apiKey) {[m
[32m+[m[32m      return { statusCode: 500, headers, body: JSON.stringify({ error: 'OPENAI_API_KEY ausente' }) };[m
[32m+[m[32m    }[m
[32m+[m[32m    if (!supabaseUrl) {[m
[32m+[m[32m      return { statusCode: 500, headers, body: JSON.stringify({ error: 'SUPABASE_URL ausente' }) };[m
[32m+[m[32m    }[m
[32m+[m[32m    if (!supabaseServiceKey) {[m
[32m+[m[32m      return { statusCode: 500, headers, body: JSON.stringify({ error: 'SUPABASE_SERVICE_ROLE_KEY ausente' }) };[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    const supabase = createClient(supabaseUrl, supabaseServiceKey);[m
[32m+[m
[32m+[m[32m    const body = JSON.parse(event.body || '{}');[m
[32m+[m[32m    const message = body.message;[m
[32m+[m[32m    const history = Array.isArray(body.history) ? body.history : [];[m
[32m+[m[32m    const userId = body.userId;[m
[32m+[m
[32m+[m[32m    if (!userId || typeof userId !== 'string') {[m
[32m+[m[32m      return { statusCode: 400, headers, body: JSON.stringify({ error: 'userId ausente' }) };[m
[32m+[m[32m    }[m
[32m+[m[32m    if (!message || typeof message !== 'string') {[m
[32m+[m[32m      return { statusCode: 400, headers, body: JSON.stringify({ error: 'Mensagem invÃ¡lida' }) };[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // 1) profile (quiz + memoria)[m
[32m+[m[32m    const { data: profile, error: profileErr } = await supabase[m
[32m+[m[32m      .from('profiles')[m
[32m+[m[32m      .select('ai_context, ai_memory')[m
[32m+[m[32m      .eq('id', userId)[m
[32m+[m[32m      .single();[m
[32m+[m
[32m+[m[32m    if (profileErr) {[m
[32m+[m[32m      return { statusCode: 500, headers, body: JSON.stringify({ error: 'Erro ao ler profiles' }) };[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // 2) eventos recentes[m
[32m+[m[32m    const { data: events } = await supabase[m
[32m+[m[32m      .from('user_events')[m
[32m+[m[32m      .select('type, payload, created_at')[m
[32m+[m[32m      .eq('user_id', userId)[m
[32m+[m[32m      .order('created_at', { ascending: false })[m
[32m+[m[32m      .limit(12);[m
[32m+[m
[32m+[m[32m    const eventsText =[m
[32m+[m[32m      (events && events.length)[m
[32m+[m[32m        ? events.map(e => `- ${e.type}: ${JSON.stringify(e.payload || {})}`).join('\n')[m
[32m+[m[32m        : 'Nenhum';[m
[32m+[m
[32m+[m[32m    const systemPrompt = `[m
[32m+[m[32mVocÃª Ã© o Companheiro do Vivamente (saÃºde mental e alta performance). NÃƒO clÃ­nico.[m
[32m+[m[32mResponda em PT-BR, curto, claro, empÃ¡tico, fÃ¡cil de ler.[m
[32m+[m
[32m+[m[32mFORMATO:[m
[32m+[m[32m- 2 a 5 blocos curtos[m
[32m+[m[32m- 1 emoji por bloco (mÃ¡x. 4)[m
[32m+[m[32m- no mÃ¡ximo 3 sugestÃµes[m
[32m+[m[32m- termine com 1 pergunta curta[m
[32m+[m[32m- proibido: listas numeradas (1.,2.,3.), tÃ­tulos e Markdown[m
[32m+[m
[32m+[m[32mQUIZ (ai_context):[m
[32m+[m[32m${profile?.ai_context || 'NÃ£o informado'}[m
[32m+[m
[32m+[m[32mMEMÃ“RIA (ai_memory):[m
[32m+[m[32m${profile?.ai_memory || 'Sem memÃ³ria ainda'}[m
[32m+[m
[32m+[m[32mEVENTOS DO APP:[m
[32m+[m[32m${eventsText}[m
[32m+[m[32m`.trim();[m
[32m+[m
[32m+[m[32m    const messages = [[m
[32m+[m[32m      { role: 'system', content: systemPrompt },[m
[32m+[m[32m      ...history.slice(-20).map(m => ({[m
[32m+[m[32m        role: m.sender === 'user' ? 'user' : 'assistant',[m
[32m+[m[32m        content: safeString(m.text),[m
[32m+[m[32m      })),[m
[32m+[m[32m      { role: 'user', content: message },[m
[32m+[m[32m    ];[m
[32m+[m
[32m+[m[32m    // 3) OpenAI Responses API (Node 22 tem fetch nativo)[m
[32m+[m[32m    const res = await fetch('https://api.openai.com/v1/responses', {[m
[32m+[m[32m      method: 'POST',[m
[32m+[m[32m      headers: {[m
[32m+[m[32m        'Content-Type': 'application/json',[m
[32m+[m[32m        Authorization: `Bearer ${apiKey}`,[m
[32m+[m[32m      },[m
[32m+[m[32m      body: JSON.stringify({[m
[32m+[m[32m        model: 'gpt-4o-mini',[m
[32m+[m[32m        input: messages,[m
[32m+[m[32m        temperature: 0.7,[m
[32m+[m[32m        max_output_tokens: 260,[m
[32m+[m[32m      }),[m
[32m+[m[32m    });[m
[32m+[m
[32m+[m[32m    const data = await res.json().catch(() => ({}));[m
[32m+[m
[32m+[m[32m    if (!res.ok) {[m
[32m+[m[32m      return {[m
[32m+[m[32m        statusCode: 500,[m
[32m+[m[32m        headers,[m
[32m+[m[32m        body: JSON.stringify({ error: data?.error?.message || `Erro OpenAI: ${res.status}` }),[m
[32m+[m[32m      };[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    const text =[m
[32m+[m[32m      data?.output_text ||[m
[32m+[m[32m      data?.output?.[0]?.content?.map(c => c?.text).filter(Boolean).join('') ||[m
[32m+[m[32m      'NÃ£o consegui responder agora ðŸ˜•';[m
[32m+[m
[32m+[m[32m    // 4) atualiza memÃ³ria (curta)[m
[32m+[m[32m    const memoryLine = `\n\nU: ${message}\nA: ${text}`.trim();[m
[32m+[m[32m    const merged = `${profile?.ai_memory || ''}${memoryLine}`.trim();[m
[32m+[m[32m    const limited = merged.slice(-4000);[m
[32m+[m
[32m+[m[32m    await supabase.from('profiles').update({ ai_memory: limited }).eq('id', userId);[m
[32m+[m
[32m+[m[32m    return {[m
[32m+[m[32m      statusCode: 200,[m
[32m+[m[32m      headers,[m
[32m+[m[32m      body: JSON.stringify({[m
[32m+[m[32m        provider: 'OpenAI',[m
[32m+[m[32m        model: 'gpt-4o-mini',[m
[32m+[m[32m        text,[m
[32m+[m[32m      }),[m
[32m+[m[32m    };[m
[32m+[m[32m  } catch (err) {[m
[32m+[m[32m    console.error('openai function error:', err);[m
[32m+[m[32m    return { statusCode: 500, headers, body: JSON.stringify({ error: err.message || 'Erro interno' }) };[m
[32m+[m[32m  }[m
[32m+[m[32m};[m

[33mcommit 740f1c56f6df8d1bb95e43d41a9596dfc9bd503c[m
Author: menteviva3-coder <menteviva3@gmail.com>
Date:   Wed Dec 17 16:53:19 2025 -0300

    fix: migraÃ§Ã£o IA Gemini â†’ OpenAI (em progresso)

[1mdiff --git a/.env b/.env[m
[1mindex 76a2a3d3..7afc3664 100644[m
[1m--- a/.env[m
[1m+++ b/.env[m
[36m@@ -1,3 +1,3 @@[m
 VITE_SUPABASE_URL=https://tibaqneawoimqdbrtzcw.supabase.co[m
 VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpYmFxbmVhd29pbXFkYnJ0emN3Iiwicm9sZSI6ImFub24iLC